Bootstrap: docker
From: node:22-bookworm

%files
    requirements-agent.txt /AgentFitter/requirements-agent.txt
    image/requirements-mad.txt /AgentFitter/requirements-mad.txt

%post
    set -eux

    ###########################################
    ## Install system dependencies ############
    ###########################################

    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get install -y --no-install-recommends \
        ca-certificates bash findutils \
        python3 python3-pip python3-venv python3-dev python-is-python3 \
        wget locales build-essential gfortran \
        libtbb-dev rsync ghostscript imagemagick \
        nodejs npm cmake \
        swig autoconf libtool libboost-dev libgmp-dev libmpfr-dev \
        binutils dpkg-dev git libssl-dev \
        libx11-dev libxext-dev libxft-dev libxpm-dev libgif-dev bc

    # w3m fim

    # Cleanup
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    ###########################################
    ## Set English locale #####################
    ###########################################

    echo "en_US.UTF-8 UTF-8" > /etc/locale.gen
    locale-gen
    update-locale LANG=en_US.UTF-8 LC_CTYPE=C.UTF-8

    ###########################################
    ## Setup dirs #############################
    ###########################################

    mkdir -p /opt/envs /AgentFitter/envs/

    ###########################################
    ## Setup venvs ############################
    ###########################################

    python3 -m venv /AgentFitter/envs/Agent
    /AgentFitter/envs/Agent/bin/pip install --upgrade pip
    /AgentFitter/envs/Agent/bin/pip install --no-cache-dir --requirement /AgentFitter/requirements-agent.txt

    python3 -m venv /opt/envs/MAD
    /opt/envs/MAD/bin/pip install --upgrade pip
    /opt/envs/MAD/bin/pip install --no-cache-dir --requirement /AgentFitter/requirements-mad.txt

    ###########################################
    ## Install MadGraph and co ################
    ###########################################

    mkdir -p /opt/MG5_aMC

    # Use MAD venv for the installation
    . /opt/envs/MAD/bin/activate

    cd /opt

    # ROOT
    ROOT_VERSION="6.36.04"
    ROOT_TAR="root_v${ROOT_VERSION}.Linux-debian12-x86_64-gcc12.2.tar.gz"
    wget -q "https://root.cern/download/${ROOT_TAR}"
    tar -xzf "${ROOT_TAR}"
    rm -f "${ROOT_TAR}"

    cd /opt/root
    . bin/thisroot.sh
    cd -

    # MadGraph
    MG_VERSION="3.7.0"
    MG_TAR="MG5_aMC_v${MG_VERSION}.tar.gz"
    wget -q "https://launchpad.net/mg5amcnlo/3.0/3.6.x/+download/${MG_TAR}"
    tar -xzf "${MG_TAR}" -C /opt/MG5_aMC --strip-components=1
    rm -f "${MG_TAR}"

    # Tools
    cd /opt/MG5_aMC
    printf 'install fastjet\ninstall lhapdf6\ninstall pythia8\ninstall Delphes\nquit\n' > /opt/mg5_install.cmd

    echo "=== Starting MadGraph installation (Pythia + Delphes) ==="

    ./bin/mg5_aMC /opt/mg5_install.cmd 2>&1 | tee /opt/mg5_install.log

    FASTJET_CFG="$(find /opt/MG5_aMC/HEPTools -type f -name fastjet-config -print -quit || true)"
    LHAPDF_CFG="$(find /opt/MG5_aMC/HEPTools -type f -name lhapdf-config -print -quit || true)"

    {
        [ -x "$LHAPDF_CFG" ]  && echo "set lhapdf ${LHAPDF_CFG}"
        [ -x "$FASTJET_CFG" ] && echo "set fastjet ${FASTJET_CFG}"
        echo "save options /opt/MG5_aMC/input/mg5_configuration.txt"
        echo "quit"
    } > /opt/mg5_fix.cmd

    /opt/MG5_aMC/bin/mg5_aMC /opt/mg5_fix.cmd

    echo "MadGraph installation log stored at: /opt/mg5_install.log"

%environment
    # PATH
    export PATH=/opt/MG5_aMC/bin:/AgentFitter/:/usr/local/bin:/usr/bin:/bin

    # Locale
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export LC_CTYPE=C.UTF-8

    # Agent
    export CLI_CMD="bash"

    # venvs
    export AgentVenv=/AgentFitter/envs/Agent
    export MadVenv=/opt/envs/MAD
    export VIRTUAL_ENV=$MadVenv

    # Editor
    export EDITOR=nano
    export VISUAL=$EDITOR

    # PYTHONPATH
    export PYTHONPATH="/opt/MG5_aMC/bin:/AgentFitter${PYTHONPATH:+:$PYTHONPATH}"

    # ROOT
    export ROOTSYS=/opt/root
    export PATH=$ROOTSYS/bin:$PATH
    export LD_LIBRARY_PATH=$ROOTSYS/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}

    # LHAPDF
    export LHAPDF_DIR=/opt/MG5_aMC/HEPTools/lhapdf6_py3
    export LD_LIBRARY_PATH=$LHAPDF_DIR/lib:$LHAPDF_DIR/lib64:/opt/root/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}

    # LHAPDF and FASTJET
    export PATH=/opt/MG5_aMC/HEPTools/lhapdf6_py3/bin:/opt/MG5_aMC/HEPTools/fastjet/bin:$PATH
%labels
    Base "debian:12 (bookworm)"
    Purpose "MadAgents Docker"
